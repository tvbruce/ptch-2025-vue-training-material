<!-- components/WatcherSamples/ComparisonDemo.vue -->
<template>
    <div class="comparison-demo">
        <h2>watch èˆ‡ watchEffect å°æ¯”</h2>
        <p class="route-info">ğŸ“ è·¯å¾‘ï¼š/WatcherSamples/ComparisonDemo.vue</p>

        <!-- é¸æ“‡å»ºè­° -->
        <div class="demo-section">
            <h3>ä½•æ™‚ä½¿ç”¨å“ªä¸€å€‹ï¼Ÿ</h3>
            <div class="comparison-grid">
                <div class="comparison-card watch-card">
                    <h4>ğŸ¯ ä½¿ç”¨ watch ç•¶ä½ éœ€è¦ï¼š</h4>
                    <ul>
                        <li>æ˜ç¢ºæŒ‡å®šè¦åµè½çš„æ•¸æ“šæº</li>
                        <li>ç²å–è®ŠåŒ–å‰å¾Œçš„å€¼ï¼ˆoldValue, newValueï¼‰</li>
                        <li>æ ¹æ“šç‰¹å®šæ•¸æ“šè®ŠåŒ–åŸ·è¡Œå‰¯ä½œç”¨</li>
                        <li>æ›´ç²¾ç¢ºçš„æ§åˆ¶ä½•æ™‚è§¸ç™¼</li>
                        <li>åµè½å¤šå€‹ç¨ç«‹çš„æ•¸æ“šæº</li>
                    </ul>
                </div>
                <div class="comparison-card watcheffect-card">
                    <h4>âš¡ ä½¿ç”¨ watchEffect ç•¶ä½ éœ€è¦ï¼š</h4>
                    <ul>
                        <li>è‡ªå‹•è¿½è¹¤æ‰€æœ‰ä¾è³´çš„éŸ¿æ‡‰å¼æ•¸æ“š</li>
                        <li>ç«‹å³åŸ·è¡Œä¸€æ¬¡ï¼ˆåˆå§‹åŒ–ï¼‰</li>
                        <li>ä¸éœ€è¦çŸ¥é“è®ŠåŒ–å‰çš„å€¼</li>
                        <li>æ›´ç°¡æ½”çš„èªæ³•</li>
                        <li>é¡ä¼¼ React useEffect çš„è¡Œç‚º</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- å¯¦éš›æ¡ˆä¾‹å°æ¯” -->
        <div class="demo-section">
            <h3>å¯¦éš›æ¡ˆä¾‹å°æ¯”</h3>

            <!-- ç”¨æˆ¶è³‡æ–™é©—è­‰ -->
            <div class="case-example">
                <h4>æ¡ˆä¾‹ 1ï¼šç”¨æˆ¶è³‡æ–™é©—è­‰</h4>
                <div class="controls">
                    <input v-model="userEmail" placeholder="è¼¸å…¥é›»å­éƒµä»¶" class="input-field">
                    <input v-model="userPassword" type="password" placeholder="è¼¸å…¥å¯†ç¢¼" class="input-field">
                </div>

                <div class="demo-container">
                    <div class="demo-panel">
                        <h5>ä½¿ç”¨ watch çš„æ–¹å¼</h5>
                        <div class="result">
                            <div class="display-value" :class="emailValidation.class">
                                <strong>Email é©—è­‰ï¼š</strong>{{ emailValidation.message }}
                            </div>
                            <div class="display-value" :class="passwordValidation.class">
                                <strong>å¯†ç¢¼é©—è­‰ï¼š</strong>{{ passwordValidation.message }}
                            </div>
                            <div class="display-value">
                                <strong>watch è§¸ç™¼æ¬¡æ•¸ï¼š</strong>{{ watchValidationCount }}
                            </div>
                        </div>
                        <div class="code-example">
                            <pre v-pre><code>// ä½¿ç”¨ watchï¼šç²¾ç¢ºæ§åˆ¶æ¯å€‹æ¬„ä½
watch(userEmail, (newEmail) => {
  if (!newEmail) {
    emailValidation.value = { message: 'è«‹è¼¸å…¥éƒµä»¶', class: 'warning' }
  } else if (isValidEmail(newEmail)) {
    emailValidation.value = { message: 'éƒµä»¶æ ¼å¼æ­£ç¢º', class: 'success' }
  } else {
    emailValidation.value = { message: 'éƒµä»¶æ ¼å¼éŒ¯èª¤', class: 'warning' }
  }
})

watch(userPassword, (newPassword) => {
  // ç²¾ç¢ºæ§åˆ¶å¯†ç¢¼é©—è­‰é‚è¼¯
})</code></pre>
                        </div>
                    </div>

                    <div class="demo-panel">
                        <h5>ä½¿ç”¨ watchEffect çš„æ–¹å¼</h5>
                        <div class="result">
                            <div class="display-value" :class="effectFormValidation.isValid ? 'success' : 'warning'">
                                <strong>æ•´é«”è¡¨å–®ç‹€æ…‹ï¼š</strong>{{ effectFormValidation.message }}
                            </div>
                            <div class="display-value">
                                <strong>watchEffect åŸ·è¡Œæ¬¡æ•¸ï¼š</strong>{{ watchEffectValidationCount }}
                            </div>
                        </div>
                        <div class="code-example">
                            <pre v-pre><code>// ä½¿ç”¨ watchEffectï¼šè‡ªå‹•è¿½è¹¤æ‰€æœ‰ç›¸é—œç‹€æ…‹
watchEffect(() => {
  const emailValid = isValidEmail(userEmail.value)
  const passwordValid = userPassword.value.length >= 6

  effectFormValidation.value = {
    isValid: emailValid && passwordValid,
    message: emailValid && passwordValid
      ? 'è¡¨å–®å¡«å¯«å®Œæ•´'
      : 'è«‹å®Œæ•´å¡«å¯«è¡¨å–®'
  }
})</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API æ•¸æ“šç²å– -->
            <div class="case-example">
                <h4>æ¡ˆä¾‹ 2ï¼šAPI æ•¸æ“šç²å–</h4>
                <div class="controls">
                    <select v-model="selectedUserId" class="select-field">
                        <option value="">é¸æ“‡ç”¨æˆ¶</option>
                        <option value="1">ç”¨æˆ¶ 1</option>
                        <option value="2">ç”¨æˆ¶ 2</option>
                        <option value="3">ç”¨æˆ¶ 3</option>
                    </select>
                    <input v-model="searchQuery" placeholder="æœç´¢é—œéµå­—" class="input-field">
                </div>

                <div class="demo-container">
                    <div class="demo-panel">
                        <h5>ä½¿ç”¨ watchï¼ˆç²¾ç¢ºæ§åˆ¶ï¼‰</h5>
                        <div class="result">
                            <div class="display-value">
                                <strong>ç•¶å‰ç”¨æˆ¶ï¼š</strong>{{ watchUserData.name || 'ç„¡' }}
                            </div>
                            <div class="display-value">
                                <strong>æœç´¢çµæœï¼š</strong>{{ watchSearchResults.length }} ç­†
                            </div>
                            <div class="display-value">
                                <strong>API å‘¼å«æ¬¡æ•¸ï¼š</strong>{{ watchApiCallCount }}
                            </div>
                        </div>
                        <div class="code-example">
                            <pre v-pre><code>// åˆ†åˆ¥æ§åˆ¶ä¸åŒ API å‘¼å«
watch(selectedUserId, async (newId) => {
  if (newId) {
    watchUserData.value = await fetchUser(newId)
  }
})

watch(searchQuery, async (newQuery) => {
  if (newQuery.length > 2) {
    watchSearchResults.value = await searchData(newQuery)
  }
}, { debounce: 300 })</code></pre>
                        </div>
                    </div>

                    <div class="demo-panel">
                        <h5>ä½¿ç”¨ watchEffectï¼ˆè‡ªå‹•è¿½è¹¤ï¼‰</h5>
                        <div class="result">
                            <div class="display-value">
                                <strong>ç¶œåˆæ•¸æ“šç‹€æ…‹ï¼š</strong>{{ effectDataStatus }}
                            </div>
                            <div class="display-value">
                                <strong>æ•¸æ“šæ›´æ–°æ¬¡æ•¸ï¼š</strong>{{ watchEffectDataCount }}
                            </div>
                        </div>
                        <div class="code-example">
                            <pre v-pre><code>// è‡ªå‹•è¿½è¹¤æ‰€æœ‰ç›¸é—œè®ŠåŒ–
watchEffect(async () => {
  // ä»»ä½•ç”¨åˆ°çš„éŸ¿æ‡‰å¼æ•¸æ“šè®ŠåŒ–éƒ½æœƒè§¸ç™¼
  if (selectedUserId.value && searchQuery.value) {
    effectDataStatus.value = 'è¼‰å…¥ä¸­...'
    // åŒæ™‚ç²å–ç”¨æˆ¶å’Œæœç´¢æ•¸æ“š
    const [user, results] = await Promise.all([
      fetchUser(selectedUserId.value),
      searchData(searchQuery.value)
    ])
    effectDataStatus.value = `${user.name}ï¼Œæ‰¾åˆ° ${results.length} ç­† "${searchQuery.value}" çš„çµæœ`
  }
})</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½å°æ¯” -->
        <div class="demo-section">
            <h3>æ€§èƒ½è€ƒé‡</h3>
            <div class="performance-grid">
                <div class="performance-card">
                    <h4>âš¡ watch ç‰¹é»</h4>
                    <ul>
                        <li><strong>æƒ°æ€§åŸ·è¡Œï¼š</strong>åªåœ¨æ•¸æ“šè®ŠåŒ–æ™‚åŸ·è¡Œ</li>
                        <li><strong>ç²¾ç¢ºæ§åˆ¶ï¼š</strong>åªç›£è½æŒ‡å®šçš„æ•¸æ“šæº</li>
                        <li><strong>è¼ƒä½é–‹éŠ·ï¼š</strong>ä¸éœ€è¦è‡ªå‹•ä¾è³´è¿½è¹¤</li>
                        <li><strong>é©åˆï¼š</strong>æ•¸æ“šæºæ˜ç¢ºä¸”ç›¸å°ç¨ç«‹çš„å ´æ™¯</li>
                    </ul>
                </div>
                <div class="performance-card">
                    <h4>ğŸ”„ watchEffect ç‰¹é»</h4>
                    <ul>
                        <li><strong>ç«‹å³åŸ·è¡Œï¼š</strong>çµ„ä»¶åˆå§‹åŒ–æ™‚å°±åŸ·è¡Œä¸€æ¬¡</li>
                        <li><strong>è‡ªå‹•è¿½è¹¤ï¼š</strong>ä¾è³´æ”¶é›†æœ‰ä¸€å®šé–‹éŠ·</li>
                        <li><strong>é‡è¤‡åŸ·è¡Œï¼š</strong>ä»»ä½•ä¾è³´è®ŠåŒ–éƒ½æœƒè§¸ç™¼</li>
                        <li><strong>é©åˆï¼š</strong>éœ€è¦éŸ¿æ‡‰å¤šå€‹æ•¸æ“šæºçš„å‰¯ä½œç”¨</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æœ€ä½³å¯¦è¸ -->
        <div class="demo-section">
            <h3>é¸æ“‡å»ºè­°èˆ‡æœ€ä½³å¯¦è¸</h3>
            <div class="best-practices">
                <div class="practice-item good">
                    <h6>âœ… å„ªå…ˆä½¿ç”¨ watch ç•¶ï¼š</h6>
                    <ul>
                        <li>éœ€è¦å°æ¯”è®ŠåŒ–å‰å¾Œçš„å€¼</li>
                        <li>åªéœ€è¦ç›£è½ç‰¹å®šçš„æ•¸æ“šæº</li>
                        <li>éœ€è¦å»¶é²åŸ·è¡Œæˆ–æ¢ä»¶åŸ·è¡Œ</li>
                        <li>æ€§èƒ½æ•æ„Ÿçš„å ´æ™¯</li>
                    </ul>
                </div>
                <div class="practice-item good">
                    <h6>âœ… é¸æ“‡ watchEffect ç•¶ï¼š</h6>
                    <ul>
                        <li>éœ€è¦éŸ¿æ‡‰å¤šå€‹ç›¸é—œçš„éŸ¿æ‡‰å¼æ•¸æ“š</li>
                        <li>é‚è¼¯éœ€è¦ç«‹å³åŸ·è¡Œä¸€æ¬¡</li>
                        <li>ä¸é—œå¿ƒè®ŠåŒ–å‰çš„å€¼</li>
                        <li>å¸Œæœ›æ›´ç°¡æ½”çš„ç¨‹å¼ç¢¼</li>
                    </ul>
                </div>
                <div class="practice-item caution">
                    <h6>âš ï¸ æ³¨æ„äº‹é …ï¼š</h6>
                    <ul>
                        <li>é¿å…åœ¨ watchEffect ä¸­ä¿®æ”¹å®ƒæ­£åœ¨è¿½è¹¤çš„æ•¸æ“šï¼ˆç„¡é™å¾ªç’°ï¼‰</li>
                        <li>è¤‡é›œé‚è¼¯æ™‚ï¼Œwatch é€šå¸¸æ›´å®¹æ˜“ç†è§£å’Œç¶­è­·</li>
                        <li>è¨˜å¾—åœ¨é©ç•¶æ™‚æ©Ÿåœæ­¢åµè½å™¨ï¼ˆçµ„ä»¶å¸è¼‰æ™‚ï¼‰</li>
                        <li>å¤§é‡æ•¸æ“šè®ŠåŒ–æ™‚ï¼Œè€ƒæ…®ä½¿ç”¨é˜²æŠ–ï¼ˆdebounceï¼‰</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, watch, watchEffect } from 'vue'

// ç”¨æˆ¶è³‡æ–™é©—è­‰
const userEmail = ref('')
const userPassword = ref('')
const emailValidation = ref({ message: 'è«‹è¼¸å…¥éƒµä»¶', class: 'info' })
const passwordValidation = ref({ message: 'è«‹è¼¸å…¥å¯†ç¢¼', class: 'info' })
const effectFormValidation = ref({ isValid: false, message: 'è«‹å¡«å¯«è¡¨å–®' })
const watchValidationCount = ref(0)
const watchEffectValidationCount = ref(0)

// éƒµä»¶é©—è­‰å‡½æ•¸
const isValidEmail = (email) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
}

// watch æ–¹å¼é©—è­‰
watch(userEmail, (newEmail) => {
    watchValidationCount.value++
    if (!newEmail) {
        emailValidation.value = { message: 'è«‹è¼¸å…¥éƒµä»¶', class: 'info' }
    } else if (isValidEmail(newEmail)) {
        emailValidation.value = { message: 'éƒµä»¶æ ¼å¼æ­£ç¢º', class: 'success' }
    } else {
        emailValidation.value = { message: 'éƒµä»¶æ ¼å¼éŒ¯èª¤', class: 'warning' }
    }
})

watch(userPassword, (newPassword) => {
    watchValidationCount.value++
    if (!newPassword) {
        passwordValidation.value = { message: 'è«‹è¼¸å…¥å¯†ç¢¼', class: 'info' }
    } else if (newPassword.length < 6) {
        passwordValidation.value = { message: 'å¯†ç¢¼è‡³å°‘ 6 å€‹å­—ç¬¦', class: 'warning' }
    } else {
        passwordValidation.value = { message: 'å¯†ç¢¼å¼·åº¦è‰¯å¥½', class: 'success' }
    }
})

// watchEffect æ–¹å¼é©—è­‰
watchEffect(() => {
    watchEffectValidationCount.value++
    const emailValid = userEmail.value && isValidEmail(userEmail.value)
    const passwordValid = userPassword.value && userPassword.value.length >= 6

    effectFormValidation.value = {
        isValid: emailValid && passwordValid,
        message: emailValid && passwordValid
            ? 'è¡¨å–®å¡«å¯«å®Œæ•´ï¼Œå¯ä»¥æäº¤'
            : 'è«‹å®Œæ•´å¡«å¯«è¡¨å–®è³‡æ–™'
    }
})

// API æ•¸æ“šç²å–æ¨¡æ“¬
const selectedUserId = ref('')
const searchQuery = ref('')
const watchUserData = ref({ name: '' })
const watchSearchResults = ref([])
const watchApiCallCount = ref(0)
const effectDataStatus = ref('è«‹é¸æ“‡ç”¨æˆ¶ä¸¦è¼¸å…¥æœç´¢å…§å®¹')
const watchEffectDataCount = ref(0)

// æ¨¡æ“¬ API å‡½æ•¸
const fetchUser = async (userId) => {
    await new Promise(resolve => setTimeout(resolve, 300))
    return { name: `ç”¨æˆ¶ ${userId}`, id: userId }
}

const searchData = async (query) => {
    await new Promise(resolve => setTimeout(resolve, 200))
    return Array.from({ length: Math.floor(Math.random() * 10) + 1 }, (_, i) => ({
        id: i,
        title: `${query} ç›¸é—œçµæœ ${i + 1}`
    }))
}

// watch æ–¹å¼è™•ç† API
watch(selectedUserId, async (newId) => {
    if (newId) {
        watchApiCallCount.value++
        watchUserData.value = await fetchUser(newId)
    } else {
        watchUserData.value = { name: '' }
    }
})

watch(searchQuery, async (newQuery) => {
    if (newQuery && newQuery.length > 2) {
        watchApiCallCount.value++
        watchSearchResults.value = await searchData(newQuery)
    } else {
        watchSearchResults.value = []
    }
})

// watchEffect æ–¹å¼è™•ç†
watchEffect(async () => {
    watchEffectDataCount.value++

    if (selectedUserId.value && searchQuery.value && searchQuery.value.length > 2) {
        effectDataStatus.value = 'è¼‰å…¥ä¸­...'
        try {
            const [user, results] = await Promise.all([
                fetchUser(selectedUserId.value),
                searchData(searchQuery.value)
            ])
            effectDataStatus.value = `${user.name}ï¼Œæ‰¾åˆ° ${results.length} ç­† "${searchQuery.value}" çš„çµæœ`
        } catch {
            effectDataStatus.value = 'è¼‰å…¥å¤±æ•—'
        }
    } else if (selectedUserId.value) {
        effectDataStatus.value = 'è«‹è¼¸å…¥æœç´¢é—œéµå­—ï¼ˆè‡³å°‘ 3 å€‹å­—ç¬¦ï¼‰'
    } else if (searchQuery.value) {
        effectDataStatus.value = 'è«‹é¸æ“‡ç”¨æˆ¶'
    } else {
        effectDataStatus.value = 'è«‹é¸æ“‡ç”¨æˆ¶ä¸¦è¼¸å…¥æœç´¢å…§å®¹'
    }
})
</script>
